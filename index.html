<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Willian & Sara | Confirmação</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
      :root {
        --cor-primaria: #0A4F3A;
        --cor-primaria-hover: #073a2b;
        --cor-recusar: #D93025;
        --cor-texto-escuro: #333333;
        --cor-texto-suave: #666666;
        --cor-branco: #FFFFFF; 
        --cor-fundo-card: rgba(255, 255, 255, 0.95);
        --glass-bg: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.2);
      }
      
      * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

      body {
        font-family: 'Montserrat', sans-serif;
        margin: 0; padding: 20px;
        color: var(--cor-branco);
        display: flex; align-items: center; justify-content: center;
        min-height: 100vh; 
        background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), 
                          url('https://i.imgur.com/8Sq1suX.jpeg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed; 
        text-shadow: 0 2px 4px rgba(0,0,0,0.7);
      }

      #app {
        width: 100%; max-width: 480px;
        background: var(--glass-bg);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        padding: 30px; 
        border-radius: 20px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        height: 85vh; 
        border: 1px solid var(--glass-border);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      
      @media (max-width: 480px) {
        body { padding: 0; align-items: flex-start; }
        #app {
          max-width: none; width: 100%; height: 100dvh; 
          border-radius: 0; margin: 0; box-shadow: none;
          padding: 20px; border: none;
          background: rgba(0, 0, 0, 0.45); 
        }
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 4px; }
      ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
      ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.5); border-radius: 2px; }

      .header { text-align: center; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); margin-bottom: 15px; flex-shrink: 0; }
      .header h1 { margin: 0; font-size: 26px; font-weight: 800; color: #FFF; letter-spacing: 1px; }
      .header p { margin: 5px 0 0; font-size: 13px; color: #EEE; text-transform: uppercase; letter-spacing: 3px; font-weight: 500; }

      /* Gerenciamento de Telas (Views) */
      .view-section { width: 100%; display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; display: none; }
      .view-active { display: flex; }

      /* Inputs e Botões */
      input[type="text"], input[type="date"], select {
        width: 100%; padding: 15px;
        border: 2px solid rgba(255,255,255,0.3);
        background: rgba(255,255,255,0.95);
        color: var(--cor-texto-escuro); border-radius: 10px; font-size: 16px;
        font-weight: 600; margin-bottom: 10px; text-shadow: none; 
        transition: border-color 0.2s;
      }
      input[type="text"]:focus { border-color: var(--cor-primaria); }

      button {
        width: 100%; padding: 16px;
        background-color: var(--cor-primaria);
        color: white; border: none; border-radius: 10px;
        font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
        cursor: pointer; transition: all 0.2s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        text-shadow: none; flex-shrink: 0; margin-top: auto;
      }
      button:active { transform: scale(0.97); }
      button:disabled { background-color: #555; cursor: not-allowed; opacity: 0.8; }
      
      button.secondary { background-color: #444; margin-top: 10px; padding: 12px; font-size: 14px; }

      /* Cards de Convidados (Usuário) */
      #nomesContainer { flex-grow: 1; overflow-y: auto; padding-right: 5px; margin-bottom: 15px; }
      .convidado-item { 
        background: var(--cor-fundo-card); border-radius: 12px; padding: 15px; 
        margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); text-shadow: none; 
        border-left: 4px solid var(--cor-primaria);
      }
      .convidado-item p.nome { margin: 0 0 5px; color: var(--cor-texto-escuro); font-weight: 700; font-size: 16px; }
      
      .radio-group { display: flex; background: #EEE; border-radius: 8px; padding: 4px; gap: 4px; }
      .radio-group input { display: none; }
      .radio-group label { 
        flex: 1; text-align: center; padding: 10px 5px; border-radius: 6px; 
        font-size: 13px; font-weight: 600; color: #777; cursor: pointer; 
        display: flex; align-items: center; justify-content: center; gap: 5px; 
        transition: all 0.2s;
      }
      .radio-group input[value="Confirmado"]:checked + label { background: var(--cor-primaria); color: white; }
      .radio-group input[value="Recusado"]:checked + label { background: var(--cor-recusar); color: white; }

      /* Countdown */
      #countdown-container { margin-bottom: 25px; text-align: center; flex-shrink: 0; }
      .countdown-title { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: #EEE; margin-bottom: 10px; opacity: 0.9; }
      #countdown { display: flex; justify-content: center; gap: 15px; }
      .time-block { display: flex; flex-direction: column; align-items: center; min-width: 45px; }
      .numero { font-size: 32px; font-weight: 700; line-height: 1; color: #FFF; font-variant-numeric: tabular-nums; }
      .label { font-size: 9px; text-transform: uppercase; opacity: 0.8; margin-top: 4px; }

      /* Loadings e Mensagens */
      #loading, #mensagem { text-align: center; padding: 12px; border-radius: 8px; margin-top: 10px; font-weight: 600; text-shadow: none; font-size: 14px; }
      #loading { background: rgba(255,255,255,0.95); color: #333; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: none; position: absolute; bottom: 20px; left: 20px; right: 20px; z-index: 200; }
      #mensagem { display: none; }
      
      #telaSucesso { text-align: center; justify-content: center; height: 100%; flex-direction: column; }
      #telaSucesso h2 { font-size: 32px; margin-bottom: 10px; color: #FFF; }

    </style>
  </head>
  <body>
    <div id="app">
      
      <div class="header" id="mainHeader">
        <h1>Willian & Sara</h1>
        <p>Fevereiro 2026</p>
      </div>

      <div id="view-login" class="view-section view-active">
        <div id="countdown-container">
          <div class="countdown-title">Confirmações encerram em:</div>
          <div id="countdown">
            <div class="time-block"><span id="days" class="numero">--</span><span class="label">Dias</span></div>
            <div class="time-block"><span id="hours" class="numero">--</span><span class="label">Hs</span></div>
            <div class="time-block"><span id="minutes" class="numero">--</span><span class="label">Min</span></div>
            <div class="time-block"><span id="seconds" class="numero">--</span><span class="label">Seg</span></div>
          </div>
          <div style="font-size:11px; margin-top:10px; opacity:0.8;">Prazo: <strong id="lblPrazo">10/01/2026</strong></div>
        </div>
        
        <div>
          <p style="text-align:center; margin-bottom:12px; opacity:0.9; font-size:14px; font-weight: 500;">Digite o código do seu convite:</p>
          <input type="text" id="codigoInput" placeholder="WS-00-00" maxlength="10" autocomplete="off" style="text-align:center; text-transform:uppercase; letter-spacing:1px;">
          <button id="btnBuscar" onclick="buscar()">Confirmar Presença</button>
        </div>
      </div>

      <div id="view-rsvp" class="view-section">
        <p style="text-align:center; margin-bottom:15px; font-size:14px; opacity:0.95; flex-shrink: 0;">Selecione quem irá comparecer:</p>
        <div id="nomesContainer"></div>
        <button id="btnConfirmar" onclick="enviarConfirmacao()">Salvar Confirmação</button>
        <button class="secondary" onclick="sair()">Voltar</button>
      </div>

      <div id="telaSucesso" class="view-section" style="display:none;">
        <div style="font-size: 60px; margin-bottom: 10px;">✅</div>
        <h2>Confirmado!</h2>
        <p>Sua resposta foi salva.</p>
        <button class="secondary" style="background:transparent; border:1px solid #FFF; margin-top:20px;" onclick="sair()">Voltar ao Início</button>
      </div>

      <div id="loading">Carregando...</div>
      <div id="mensagem"></div>
    </div>

    <script>
      // ==========================================
      // SEU LINK FIXO AQUI
      // ==========================================
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwsg3trPiCdX59SL4xudGWKU5qwPxwq_PG71ENsbULaO40I9PzEGzYB78nwh9Ha1kGN/exec"; 
      
      const SENHA_MESTRA = "ADMIN"; // SENHA PARA ACESSAR O PAINEL
      let deadline = new Date(2026, 0, 11, 0, 0, 0).getTime(); 

      // --- MÁSCARA INTELIGENTE ---
      // Permite digitar "ADMIN" sem colocar traços, mas coloca traços em convites normais
      const inputCodigo = document.getElementById('codigoInput');
      inputCodigo.addEventListener('input', function(e) {
          let v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
          
          // LÓGICA DE CORREÇÃO:
          // Se o que o usuário está digitando (ex: "AD", "ADM") for o começo da senha mestra,
          // NÃO aplica a máscara de traços.
          if(SENHA_MESTRA.startsWith(v)) {
              e.target.value = v;
              return;
          }

          // Caso contrário (convite normal), aplica a máscara XX-XX-XX
          if (v.length > 8) v = v.slice(0, 8);
          if (v.length > 2) v = v.slice(0, 2) + '-' + v.slice(2);
          if (v.length > 5) v = v.slice(0, 5) + '-' + v.slice(5);
          e.target.value = v;
      });

      function iniciarContador() {
        const now = new Date().getTime();
        const diff = deadline - now;
        if (diff < 0) {
          document.getElementById('countdown').innerHTML = "<div style='color:#FFF; font-weight:700'>PRAZO ENCERRADO</div>";
          return;
        }
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);
        
        const f = n => n < 10 ? '0'+n : n;
        document.getElementById('days').innerText = f(d);
        document.getElementById('hours').innerText = f(h);
        document.getElementById('minutes').innerText = f(m);
        document.getElementById('seconds').innerText = f(s);
      }
      setInterval(iniciarContador, 1000);
      iniciarContador();

      // --- NAVEGAÇÃO ---
      function switchView(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('view-active'));
        const target = document.getElementById('view-' + viewName);
        if(target) target.classList.add('view-active');
        
        const header = document.getElementById('mainHeader');
        if(viewName === 'sucesso') {
             document.getElementById('telaSucesso').style.display = 'flex';
             header.style.display = 'none';
        } else {
             document.getElementById('telaSucesso').style.display = 'none';
             header.style.display = 'block';
        }
      }

      function sair() {
        document.getElementById('codigoInput').value = '';
        switchView('login');
        alertMsg("");
      }

      // --- API COM TEXT/PLAIN PARA EVITAR CORS ---
      async function enviarDados(action, dados = {}) {
        const params = {
            method: "POST",
            body: JSON.stringify({ action: action, ...dados })
        };
        // fetch direto
        return fetch(SCRIPT_URL, params).then(r => r.json());
      }

      // --- BUSCAR / LOGIN ---
      function buscar() {
        var rawValue = document.getElementById('codigoInput').value.toUpperCase();
        var limpo = rawValue.replace(/[^A-Z0-9]/g, '');

        // REDIRECIONAMENTO PARA O PAINEL DE CONTROLE
        if(limpo === SENHA_MESTRA) {
            // Certifique-se de que o arquivo admin.html está na mesma pasta/deploy
            window.location.href = "admin.html"; 
            return;
        }

        if (limpo.length < 5) return alertMsg("Código muito curto.", true);
        
        toggleLoading(true, "Verificando...");
        enviarDados('buscar', { codigo: rawValue })
          .then(r => {
             toggleLoading(false);
             if (r.error) return alertMsg(r.error, true);
             if (r.dataLimite) atualizarPrazo(r.dataLimite);
             mostrarListaConvidados(r.convidados);
          })
          .catch(e => tratarErro(e));
      }

      function atualizarPrazo(dataString) {
          let novaData = new Date(dataString);
          if (!isNaN(novaData)) {
              deadline = novaData.getTime();
              let dia = String(novaData.getDate()).padStart(2, '0');
              let mes = String(novaData.getMonth() + 1).padStart(2, '0');
              document.getElementById('lblPrazo').innerText = `${dia}/${mes}/${novaData.getFullYear()}`;
          }
      }

      function mostrarListaConvidados(convidados) {
        var html = "";
        convidados.forEach(c => {
          var isConf = c.status === 'Confirmado' ? 'checked' : '';
          var isRec = c.status === 'Recusado' ? 'checked' : '';
          var grp = `rsvp_${c.linha}`;
          
          html += `
            <div class="convidado-item">
              <p class="nome">${c.nome}</p>
              <div class="radio-group">
                <input type="radio" name="${grp}" id="${grp}_y" value="Confirmado" data-linha="${c.linha}" ${isConf}>
                <label for="${grp}_y">✅ Vou</label>
                <input type="radio" name="${grp}" id="${grp}_n" value="Recusado" data-linha="${c.linha}" ${isRec}>
                <label for="${grp}_n">❌ Não vou</label>
              </div>
            </div>`;
        });
        document.getElementById('nomesContainer').innerHTML = html;
        switchView('rsvp');
      }

      function enviarConfirmacao() {
        toggleLoading(true, "Enviando...");
        var respostas = [];
        document.querySelectorAll('#nomesContainer input:checked').forEach(input => {
          respostas.push({ linha: parseInt(input.dataset.linha), status: input.value });
        });
        enviarDados('atualizar', { respostas: respostas })
          .then(res => {
             toggleLoading(false);
             if(res.error) throw new Error(res.error);
             switchView('sucesso'); 
          }).catch(e => tratarErro(e));
      }

      function tratarErro(e) {
        toggleLoading(false);
        alertMsg("⚠️ " + (e.message || "Erro de conexão"), true);
      }

      function alertMsg(msg, erro=false) {
        var div = document.getElementById('mensagem');
        if(!msg) { div.style.display = 'none'; return; }
        div.style.display = 'block'; div.innerText = msg;
        div.style.backgroundColor = erro ? '#ffdddd' : '#ddffdd';
        div.style.color = erro ? '#a00' : '#0a0';
        setTimeout(() => div.style.display='none', 4000);
      }

      function toggleLoading(show, txt) {
        var div = document.getElementById('loading');
        div.style.display = show ? 'block' : 'none';
        if(txt) div.innerText = txt;
      }
    </script>
  </body>
</html>
