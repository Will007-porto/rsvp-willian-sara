<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Willian & Sara | Confirma√ß√£o</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
      :root {
        --cor-primaria: #0A4F3A;
        --cor-primaria-hover: #073a2b;
        --cor-recusar: #D93025;
        --cor-texto-principal: #333333;
        --cor-texto-branco: #FFFFFF; 
        --cor-fundo-card: rgba(255, 255, 255, 0.95);
      }
      
      * { box-sizing: border-box; }

      body {
        font-family: 'Montserrat', sans-serif;
        margin: 0; padding: 20px;
        color: var(--cor-texto-branco);
        display: flex; align-items: center; justify-content: center;
        min-height: 100vh; 
        background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), 
                          url('https://i.imgur.com/8Sq1suX.jpeg');
        background-size: cover; background-position: center; background-attachment: fixed; 
        text-shadow: 0 2px 4px rgba(0,0,0,0.6);
        overflow-x: hidden;
      }

      #app {
        width: 100%; max-width: 480px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        padding: 30px; border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        display: flex; flex-direction: column; height: 85vh; 
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      
      @media (max-width: 480px) {
        body { padding: 0; }
        #app { max-width: none; width: 100%; height: 100dvh; border-radius: 0; padding: 20px; background: rgba(0,0,0,0.6); border:none; }
      }

      .header { text-align: center; margin-bottom: 20px; flex-shrink: 0; }
      .header h1 { margin: 0; font-size: 26px; font-weight: 700; color: #FFF; letter-spacing: 1px; }
      .header p { margin: 5px 0 0; font-size: 13px; color: #DDD; text-transform: uppercase; letter-spacing: 2px; }

      #conteudo-ativo, #listaConvidados, #painelAdmin, #telaSucesso { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; display: none; }
      
      /* --- HOME / LOGIN --- */
      #conteudo-ativo { display: flex; }
      #countdown-container { margin-bottom: 30px; text-align: center; }
      .countdown-title { font-size: 11px; text-transform: uppercase; color: #EEE; margin-bottom: 8px; }
      #countdown { display: flex; justify-content: center; gap: 15px; }
      .time-block { display: flex; flex-direction: column; align-items: center; }
      .numero { font-size: 32px; font-weight: 700; line-height: 1; color: #FFF; }
      .label { font-size: 10px; text-transform: uppercase; opacity: 0.8; margin-top: 2px; }
      
      input, select {
        width: 100%; padding: 15px; border: none;
        background: rgba(255,255,255,0.95); color: #333;
        border-radius: 8px; font-size: 16px; font-weight: 600;
        margin-bottom: 12px; text-align: center; text-transform: uppercase;
      }
      button {
        width: 100%; padding: 16px; background-color: var(--cor-primaria);
        color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 700;
        text-transform: uppercase; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-top: auto;
      }
      button:active { transform: scale(0.98); }
      button.secondary { background-color: #555; margin-top: 10px; }
      button.acao { margin-top: 0; font-size: 14px; padding: 12px; }

      /* --- LISTA --- */
      #nomesContainer { flex-grow: 1; overflow-y: auto; padding-right: 5px; margin-bottom: 15px; }
      .convidado-item { background: var(--cor-fundo-card); border-radius: 10px; padding: 15px; margin-bottom: 10px; text-shadow: none; color: #333; }
      .convidado-item p.nome { margin: 0 0 5px; font-weight: 700; font-size: 16px; }
      .radio-group { display: flex; background: #EEE; border-radius: 8px; padding: 4px; gap: 5px; }
      .radio-group label { flex: 1; text-align: center; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: 600; color: #666; cursor: pointer; }
      .radio-group input:checked + label[for*="_y"] { background: var(--cor-primaria); color: white; }
      .radio-group input:checked + label[for*="_n"] { background: var(--cor-recusar); color: white; }
      input[type="radio"] { display: none; }

      /* --- ADMIN SALA DE CONTROLE --- */
      .admin-section { background: rgba(0,0,0,0.4); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
      .admin-title { font-size: 12px; text-transform: uppercase; font-weight: 700; color: #BBB; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
      
      .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; overflow-y: auto; max-height: 200px; }
      .stat-card { background: #FFF; padding: 10px; border-radius: 8px; text-align: center; color: #333; text-shadow: none; }
      .stat-card.full { grid-column: span 2; }
      .stat-val { font-size: 22px; font-weight: 800; }
      .stat-lbl { font-size: 9px; text-transform: uppercase; color: #666; font-weight: 700; }
      .stat-sub { font-size: 9px; color: #888; }

      .form-admin input, .form-admin select { margin-bottom: 8px; font-size: 14px; padding: 10px; text-align: left; }
      
      #loading, #mensagem { text-align: center; padding: 10px; background: #FFF; color: #333; border-radius: 8px; margin-top: 10px; font-weight: 600; text-shadow: none; display: none; }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="header">
        <h1>Willian & Sara</h1>
        <p>Fevereiro 2026</p>
      </div>

      <div id="conteudo-ativo">
        <div id="countdown-container">
          <div class="countdown-title">Confirma√ß√µes at√© <span id="lblDataLimite">...</span></div>
          <div id="countdown">
            <div class="time-block"><span id="days" class="numero">--</span><span class="label">Dias</span></div>
            <div class="time-block"><span id="hours" class="numero">--</span><span class="label">Hs</span></div>
            <div class="time-block"><span id="minutes" class="numero">--</span><span class="label">Min</span></div>
          </div>
        </div>
        
        <div style="margin-top:auto;">
          <input type="text" id="codigoInput" placeholder="DIGITE SEU C√ìDIGO">
          <button id="btnBuscar" onclick="buscar()">Confirmar Presen√ßa</button>
        </div>
      </div>

      <div id="listaConvidados">
        <p style="text-align:center; font-size:13px; margin-bottom:10px;">Confirme quem ir√° comparecer:</p>
        <div id="nomesContainer"></div>
        <button id="btnConfirmar" onclick="enviarConfirmacao()">Salvar Confirma√ß√£o</button>
      </div>

      <div id="painelAdmin" style="overflow-y:auto;">
        <h3 style="text-align:center; margin-top:0;">‚öôÔ∏è Sala de Controle</h3>
        
        <div class="admin-section">
          <div class="admin-title">Monitoramento em Tempo Real</div>
          <div class="dashboard-grid" id="gridStats">Carregando...</div>
        </div>

        <div class="admin-section">
          <div class="admin-title">Data de Encerramento</div>
          <div style="display:flex; gap:10px;">
            <input type="date" id="adminDataLimite" style="margin:0;">
            <button class="acao" onclick="salvarData()" style="width:auto;">Salvar</button>
          </div>
        </div>

        <div class="admin-section form-admin">
          <div class="admin-title">Cadastrar Novo Convidado</div>
          <input type="text" id="novoNome" placeholder="Nome Completo">
          <select id="novoLado">
            <option value="Willian">Convidado do Willian</option>
            <option value="Sara">Convidado da Sara</option>
            <option value="Ambos">Ambos</option>
          </select>
          <div style="display:flex; gap:10px;">
            <input type="text" id="novoParentesco" placeholder="Parentesco (Ex: Tio)">
            <input type="text" id="novoCodigo" placeholder="C√≥d. Fam√≠lia (Ex: WS-XX-00)">
          </div>
          <button class="acao" onclick="adicionarNovo()">Cadastrar Tripulante</button>
        </div>

        <button class="secondary" onclick="sairAdmin()">Sair do Painel</button>
      </div>

      <div id="telaSucesso" style="text-align:center; justify-content:center;">
        <h2 style="font-size:28px;">Confirmado! ‚úÖ</h2>
        <p>Sua presen√ßa foi registrada com sucesso.</p>
        <br>
        <button class="secondary" onclick="location.reload()">Voltar</button>
      </div>

      <div id="conteudo-encerrado" style="display:none; text-align:center; justify-content:center; flex-grow:1;">
        <h2>Prazo Encerrado üîí</h2>
        <p>As confirma√ß√µes est√£o fechadas.</p>
      </div>

      <div id="loading">Processando...</div>
      <div id="mensagem"></div>
    </div>

    <script>
      // CONFIGURA√á√ÉO
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbySc_m4-r0UiREV5certyoh4uf3QA6uM4LbttTma7R9sxAG6RijzQ8VloXqRvUrgdPu/exec";
      
      // Data padr√£o caso a planilha falhe (fallback)
      let deadline = new Date(2026, 0, 11).getTime(); 

      // --- INICIALIZA√á√ÉO ---
      function iniciarContador() {
        const now = new Date().getTime();
        const diff = deadline - now;
        
        if (diff < 0) {
          document.getElementById('conteudo-ativo').style.display = 'none';
          document.getElementById('conteudo-encerrado').style.display = 'flex';
          return;
        }

        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        document.getElementById('days').innerText = d < 10 ? '0'+d : d;
        document.getElementById('hours').innerText = h < 10 ? '0'+h : h;
        document.getElementById('minutes').innerText = m < 10 ? '0'+m : m;
      }
      setInterval(iniciarContador, 1000);

      // --- COMUNICA√á√ÉO API ---
      async function enviarDados(action, dados = {}) {
        return fetch(SCRIPT_URL, {
          method: 'POST', body: JSON.stringify({ action, ...dados })
        }).then(r => r.json());
      }

      function buscar() {
        const codigo = document.getElementById('codigoInput').value.trim().toUpperCase();
        if (!codigo) return alertMsg("Digite o c√≥digo.", true);
        
        mostrarLoading(true, "Buscando...");
        enviarDados('buscar', { codigo: codigo }).then(res => {
          mostrarLoading(false);
          if(res.error) return alertMsg(res.error, true);
          
          if(res.isAdmin) {
             abrirPainelAdmin();
          } else {
             // Atualiza data limite se vier do backend
             if(res.dataLimite) {
                deadline = new Date(res.dataLimite).getTime();
                iniciarContador();
             }
             renderizarConvidados(res.convidados);
          }
        }).catch(e => {
          mostrarLoading(false);
          alertMsg("Erro de conex√£o.", true);
        });
      }

      function renderizarConvidados(lista) {
        let html = "";
        lista.forEach(c => {
          const checkSim = c.status === 'Confirmado' ? 'checked' : '';
          const checkNao = c.status === 'Recusado' ? 'checked' : '';
          html += `
            <div class="convidado-item">
              <p class="nome">${c.nome} <small style="font-weight:400; opacity:0.7">(${c.parentesco || ''})</small></p>
              <div class="radio-group">
                <input type="radio" name="rsvp_${c.linha}" id="s_${c.linha}" value="Confirmado" data-linha="${c.linha}" ${checkSim}>
                <label for="s_${c.linha}">‚úÖ Vou</label>
                <input type="radio" name="rsvp_${c.linha}" id="n_${c.linha}" value="Recusado" data-linha="${c.linha}" ${checkNao}>
                <label for="n_${c.linha}">‚ùå N√£o vou</label>
              </div>
            </div>`;
        });
        document.getElementById('nomesContainer').innerHTML = html;
        document.getElementById('conteudo-ativo').style.display = 'none';
        document.getElementById('listaConvidados').style.display = 'flex';
      }

      function enviarConfirmacao() {
        mostrarLoading(true, "Salvando...");
        const respostas = [];
        document.querySelectorAll('input[type="radio"]:checked').forEach(el => {
          respostas.push({ linha: el.dataset.linha, status: el.value });
        });
        
        enviarDados('atualizar', { respostas }).then(r => {
          mostrarLoading(false);
          document.getElementById('listaConvidados').style.display = 'none';
          document.getElementById('telaSucesso').style.display = 'flex';
        });
      }

      // --- ADMIN CONTROLS ---
      function abrirPainelAdmin() {
        document.getElementById('conteudo-ativo').style.display = 'none';
        document.getElementById('painelAdmin').style.display = 'flex';
        carregarStats();
      }
      
      function sairAdmin() {
        location.reload();
      }

      function carregarStats() {
        enviarDados('dashboard').then(d => {
          // Atualiza Data no Input
          if(d.configData) {
             // Formata para input date (yyyy-mm-dd) se necess√°rio, ou usa direto se vier iso
             let dt = new Date(d.configData);
             let iso = dt.toISOString().split('T')[0];
             document.getElementById('adminDataLimite').value = iso;
          }

          document.getElementById('gridStats').innerHTML = `
            <div class="stat-card full"><div class="stat-val">${d.total}</div><div class="stat-lbl">Total Lista</div></div>
            <div class="stat-card"><div class="stat-val" style="color:var(--cor-primaria)">${d.confirmados}</div><div class="stat-lbl">Confirmados</div></div>
            <div class="stat-card"><div class="stat-val" style="color:var(--cor-recusar)">${d.recusados}</div><div class="stat-lbl">Recusados</div></div>
            <div class="stat-card"><div class="stat-val">${d.pendentes}</div><div class="stat-lbl">Pendentes</div></div>
            <div class="stat-card" style="border:1px solid #0056b3"><div class="stat-val" style="color:#0056b3">${d.entreguesPendentes}</div><div class="stat-lbl">Entregues S/ Resp</div><div class="stat-sub">Col K="s"</div></div>
            <div class="stat-card"><div class="stat-val">${d.willian}</div><div class="stat-lbl">Willian</div></div>
            <div class="stat-card"><div class="stat-val">${d.sara}</div><div class="stat-lbl">Sara</div></div>
          `;
        });
      }

      function salvarData() {
        const novaData = document.getElementById('adminDataLimite').value;
        if(!novaData) return alert("Selecione uma data.");
        mostrarLoading(true, "Atualizando sistema...");
        
        enviarDados('salvarConfig', { novaData }).then(r => {
           mostrarLoading(false);
           alertMsg("Data atualizada com sucesso!");
        });
      }

      function adicionarNovo() {
        const dados = {
          nome: document.getElementById('novoNome').value,
          lado: document.getElementById('novoLado').value,
          parentesco: document.getElementById('novoParentesco').value,
          codigo: document.getElementById('novoCodigo').value.toUpperCase(),
          funcao: "Convidado"
        };

        if(!dados.nome || !dados.codigo) return alertMsg("Nome e C√≥digo s√£o obrigat√≥rios", true);

        mostrarLoading(true, "Cadastrando...");
        enviarDados('adicionarConvidado', { dados }).then(r => {
          mostrarLoading(false);
          alertMsg("Cadastrado com sucesso!");
          // Limpa campos
          document.getElementById('novoNome').value = "";
          document.getElementById('novoCodigo').value = "";
          carregarStats(); // Recarrega n√∫meros
        });
      }

      // --- UTILIT√ÅRIOS ---
      function alertMsg(msg, erro=false) {
        const div = document.getElementById('mensagem');
        div.style.display = 'block'; div.innerText = msg;
        div.style.color = erro ? 'red' : 'green';
        setTimeout(() => div.style.display = 'none', 3000);
      }
      function mostrarLoading(show, txt="Carregando...") {
        const div = document.getElementById('loading');
        div.style.display = show ? 'block' : 'none';
        div.innerText = txt;
      }
    </script>
  </body>
</html>
